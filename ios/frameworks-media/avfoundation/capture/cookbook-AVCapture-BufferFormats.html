<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>cookbook-AVCapture-BufferFormats</title>
</head>

<body>
<h1>cookbook-AVCapture-BufferFormats</h1>
<p>&nbsp;</p>
<p>&nbsp;</p>
<h2>From CMSampleBufferGetImageBuffer</h2>
<p>&nbsp;</p>
<table width="100%" border="1">
  <tr>
    <td>&nbsp;</td>
    <td>&nbsp;</td>
    <td>&nbsp;</td>
    <td>&nbsp;</td>
  </tr>
  <tr>
    <td>Save to Library</td>
    <td> // trivial simple JPEG case<br />
NSData *jpegData = [AVCaptureStillImageOutput jpegStillImageNSDataRepresentation:imageDataSampleBuffer];<br />
CFDictionaryRef attachments = CMCopyDictionaryOfAttachments(kCFAllocatorDefault,<br />
imageDataSampleBuffer,<br />
kCMAttachmentMode_ShouldPropagate);<br />
ALAssetsLibrary *library = [[ALAssetsLibrary alloc] init];<br />
[library writeImageDataToSavedPhotosAlbum:jpegData metadata:(id)attachments completionBlock:^(NSURL *assetURL, NSError *error) {<br />
if (error) {<br />
[self displayErrorOnMainQueue:error withMessage:@&quot;Save to camera roll failed&quot;];<br />
}<br />
}];<br />
<br />
if (attachments)<br />
CFRelease(attachments);<br />
[library release];</td>
    <td>&nbsp;</td>
    <td>&nbsp;</td>
  </tr>
  <tr>
    <td>To CVPixelBufferRef</td>
    <td>CVImageBufferRef pixelBuffer = CMSampleBufferGetImageBuffer(sampleBuffer);</td>
    <td>&nbsp;</td>
    <td>&nbsp;</td>
  </tr>
  <tr>
    <td><p>attachements</p>
    <p>used in save to library, or CIImage creation</p></td>
    <td>CFDictionaryRef attachments = CMCopyDictionaryOfAttachments(kCFAllocatorDefault,<br />
imageDataSampleBuffer,<br />
kCMAttachmentMode_ShouldPropagate);</td>
    <td>&nbsp;</td>
    <td>&nbsp;</td>
  </tr>
  <tr>
    <td>&nbsp;</td>
    <td>&nbsp;</td>
    <td>&nbsp;</td>
    <td>&nbsp;</td>
  </tr>
</table>
<p>&nbsp;</p>
<p>&nbsp;</p>
<h2>From CVPixelBufferRef </h2>
<table width="100%" border="1">
  <tr>
    <td>To</td>
    <td>&nbsp;</td>
    <td>&nbsp;</td>
    <td>&nbsp;</td>
  </tr>
  <tr>
    <td>CGImageRef</td>
    <td><p>// SquareCam</p>
      <p>static OSStatus CreateCGImageFromCVPixelBuffer(CVPixelBufferRef pixelBuffer, CGImageRef *imageOut)</p>
    <p>&nbsp;</p></td>
    <td>&nbsp;</td>
    <td>&nbsp;</td>
  </tr>
  <tr>
    <td>CIImage</td>
    <td> // Got an image.<br />
CVPixelBufferRef pixelBuffer = CMSampleBufferGetImageBuffer(imageDataSampleBuffer);<br />
CFDictionaryRef attachments = CMCopyDictionaryOfAttachments(kCFAllocatorDefault, imageDataSampleBuffer, kCMAttachmentMode_ShouldPropagate);<br />
CIImage *ciImage = [[CIImage alloc] initWithCVPixelBuffer:pixelBuffer options:(NSDictionary *)attachments];<br />
if (attachments)<br />
CFRelease(attachments);</td>
    <td>&nbsp;</td>
    <td>&nbsp;</td>
  </tr>
  <tr>
    <td>&nbsp;</td>
    <td>size_t width = CVPixelBufferGetWidth(pixelBuffer);<br />
size_t height = CVPixelBufferGetHeight(pixelBuffer);</td>
    <td>&nbsp;</td>
    <td>&nbsp;</td>
  </tr>
  <tr>
    <td>&nbsp;</td>
    <td>&nbsp;</td>
    <td>&nbsp;</td>
    <td>&nbsp;</td>
  </tr>
</table>
<p>&nbsp;</p>
<p>To ALAssetsLibrary</p>
<p>&nbsp;</p>
<p>func writeImageToSavedPhotosAlbum(_ imageRef: CGImage!,<br />
metadata metadata: [NSObject : AnyObject]!,<br />
completionBlock completionBlock: ALAssetsLibraryWriteImageCompletionBlock!)</p>
<p>&nbsp;</p>
<p>func writeImageDataToSavedPhotosAlbum(_ imageData: NSData!,<br />
metadata metadata: [NSObject : AnyObject]!,<br />
completionBlock completionBlock: ALAssetsLibraryWriteImageCompletionBlock!)</p>
<p>&nbsp;</p>
<p>func writeImageToSavedPhotosAlbum(_ imageRef: CGImage!,<br />
orientation orientation: ALAssetOrientation,<br />
completionBlock completionBlock: ALAssetsLibraryWriteImageCompletionBlock!)</p>
</body>
</html>
